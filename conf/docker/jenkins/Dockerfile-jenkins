FROM ros:humble-ros-base

LABEL authors="dadouuu"

ARG DEBIAN_FRONTEND=noninteractive

WORKDIR /home

EXPOSE 4421

# Prepare ROS 2 workspace layout expected by the runtime scripts.
RUN mkdir -p /home/ros2_ws/src/robot/resource

WORKDIR /home/ros2_ws/

# Project sources copied from the Jenkins workspace checkout.
COPY robot/ /home/ros2_ws/src/robot/robot/
COPY conf/ /home/ros2_ws/src/robot/conf/
COPY json/ /home/ros2_ws/src/robot/json/
COPY medias/ /home/ros2_ws/src/robot/medias/

# Shared utilities fetched separately by the CI script.
COPY dadou_utils_ros/ /home/ros2_ws/src/robot/dadou_utils_ros/

# ROS 2 metadata and setup files.
COPY conf/ros2_dependencies/ /home/ros2_ws/src/
COPY conf/ros2/setup.py /home/ros2_ws/src/robot/
COPY conf/ros2/package.xml /home/ros2_ws/src/robot/
COPY conf/ros2/setup.cfg /home/ros2_ws/src/robot/
COPY conf/ros2/resource/ /home/ros2_ws/src/robot/resource/

# Install system dependencies declared for Docker builds.
RUN apt-get update && \
    grep -Ev '^[[:space:]]*(#|$)' /home/ros2_ws/src/robot/conf/packages-docker.txt | \
      xargs -r apt-get install -y && \
    rm -rf /var/lib/apt/lists/*

# Ensure Python finds the ROS 2 workspace packages.
ENV PYTHONPATH=/home/ros2_ws

# Install Python requirements for the robot stack.
RUN pip3 install --no-cache-dir --ignore-installed -r /home/ros2_ws/src/robot/conf/requirements.txt

# Entry point used in production containers.
ENTRYPOINT ["/bin/bash", "-c", "source /home/ros2_ws/src/robot/conf/scripts/launch-ros-in-docker.sh"]
