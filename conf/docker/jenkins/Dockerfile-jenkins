FROM ros:humble-ros-base

LABEL authors="dadouuu"

ARG DEBIAN_FRONTEND=noninteractive

WORKDIR /home

EXPOSE 4421

# Prepare ROS 2 workspace layout expected by the runtime scripts.
RUN mkdir -p /home/ros2_ws/src/robot/resource

WORKDIR /home/ros2_ws/

# Project sources copied from the Jenkins workspace checkout.
COPY robot/ /home/ros2_ws/src/robot/robot/
COPY conf/ /home/ros2_ws/src/robot/conf/
COPY json/ /home/ros2_ws/src/robot/json/
COPY medias/ /home/ros2_ws/src/robot/medias/

# Shared utilities fetched from Git to avoid depending on host filesystem layout.
ARG DADOU_UTILS_REPO_URL="https://github.com/duvamduvam/dadou_utils_ros.git"
ARG DADOU_UTILS_REPO_BRANCH="main"
RUN apt-get update && \
    apt-get install -y git && \
    rm -rf /var/lib/apt/lists/* && \
    git clone --depth=1 --branch "${DADOU_UTILS_REPO_BRANCH}" "${DADOU_UTILS_REPO_URL}" /home/ros2_ws/src/robot/dadou_utils_ros

# Test-specific entrypoint helper.
COPY conf/docker/scripts/entrypoint-tests.sh /usr/local/bin/robot-tests-entrypoint
RUN chmod +x /usr/local/bin/robot-tests-entrypoint

# ROS 2 metadata and setup files.
COPY conf/ros2_dependencies/ /home/ros2_ws/src/
COPY conf/ros2/setup.py /home/ros2_ws/src/robot/
COPY conf/ros2/package.xml /home/ros2_ws/src/robot/
COPY conf/ros2/setup.cfg /home/ros2_ws/src/robot/
COPY conf/ros2/resource/ /home/ros2_ws/src/robot/resource/

# Install system dependencies declared for Docker builds.
RUN apt-get update && \
    grep -Ev '^[[:space:]]*(#|$)' /home/ros2_ws/src/robot/conf/packages-docker.txt | \
      xargs -r apt-get install -y && \
    rm -rf /var/lib/apt/lists/*

# Ensure Python finds the ROS 2 workspace packages.
ENV PYTHONPATH=/home/ros2_ws

# Install Python requirements for the robot stack and test suite.
RUN pip3 install --no-cache-dir --ignore-installed -r /home/ros2_ws/src/robot/conf/requirements.txt && \
    pip3 install --no-cache-dir --ignore-installed -r /home/ros2_ws/src/robot/conf/tests/requirements.txt

# Default entrypoint still launches the ROS runtime; tests can override with robot-tests-entrypoint.
ENTRYPOINT ["/bin/bash", "-c", "source /home/ros2_ws/src/robot/conf/scripts/launch-ros-in-docker.sh"]
