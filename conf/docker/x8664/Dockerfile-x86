# Base image with full desktop (RViz, Gazebo, etc.)
FROM osrf/ros:jazzy-desktop-full

# Metadata
LABEL authors="dadouuu"
WORKDIR /home

EXPOSE 4421

# Prepare ROS 2 workspace layout
RUN mkdir /home/ros2_ws
RUN mkdir /home/ros2_ws/src
RUN mkdir /home/ros2_ws/src/robot
RUN mkdir /home/ros2_ws/src/robot/resource

# Copy project sources and configuration
COPY robot/ /home/ros2_ws/src/robot/robot/
COPY conf/ /home/ros2_ws/src/robot/conf/
COPY json/ /home/ros2_ws/src/robot/json/
COPY medias/ /home/ros2_ws/src/robot/medias/

# Unpack shared utilities bundle
COPY dadou_utils_ros.tar.gz /home/ros2_ws/src/robot/
RUN tar -xzhf /home/ros2_ws/src/robot/dadou_utils_ros.tar.gz -C /home/ros2_ws/src/robot/ && \
    rm /home/ros2_ws/src/robot/dadou_utils_ros.tar.gz

# Bring ROS 2 interfaces and package metadata
COPY conf/ros2_dependencies/ /home/ros2_ws/src/

COPY conf/ros2/setup.py /home/ros2_ws/src/robot/
COPY conf/ros2/package.xml /home/ros2_ws/src/robot/
COPY conf/ros2/setup.cfg /home/ros2_ws/src/robot/
COPY conf/ros2/resource/ /home/ros2_ws/src/robot/resource/

# Add helper aliases/env setup for interactive shells in the container
COPY conf/docker/docker_bashrc /tmp/docker_bashrc
RUN cat /tmp/docker_bashrc >> /root/.bashrc && rm /tmp/docker_bashrc

# System dependencies needed by the robot stack
RUN apt-get update && cat /home/ros2_ws/src/robot/conf/packages-docker.txt | xargs apt-get install -y

# Ensure Python sees the project sources
ENV PYTHONPATH "${PYTHONPATH}:/home/src"

# Allow pip to coexist with Debian packages (ROS requirement)
ENV PIP_BREAK_SYSTEM_PACKAGES=1

# Install Python dependencies
RUN pip3 install --no-cache-dir --ignore-installed -r /home/ros2_ws/src/robot/conf/requirements.txt

#ENTRYPOINT ["/bin/bash", "-c", "source /home/ros2_ws/src/robot/conf/scripts/launch-ros-in-docker.sh"]

#COPY robot/test.py .
# Launch test entry point by default (override at runtime if needed)
ENTRYPOINT ["python3", "/home/ros2_ws/src/robot/robot/test.py"]
#CMD ["python3", "src/run.py"]

### ajouter
#source /opt/ros/jazzy/setup.bash
#cd /opt/ros/jazzy/share/urdf_tutorial
# ros2 launch urdf_tutorial display.launch.py model:=urdf/08-macroed.urdf.xacro
